<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bioc="http://bpmn.io/schema/bpmn/biocolor/1.0" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="4.7.0"><bpmn:process id="TEMPLATE_INSTANCE_PROCESS_hlk_contract_close_app_c2fc346c-2cf2-44f6-844f-af41fea44964" name="Заявка на закрытие договора" isExecutable="true"><bpmn:documentation /><bpmn:startEvent id="StartEvent_1"><bpmn:outgoing>Flow_1hsa22q</bpmn:outgoing></bpmn:startEvent><bpmn:sequenceFlow id="SequenceFlow_049okmm" sourceRef="Task_1ujk4ck" targetRef="EndEvent_0djl7a3" /><bpmn:serviceTask id="Task_1ujk4ck" name="Сообщаем об окончании процесса"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/processCompleted/${instanceId}</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_1jfor4c</bpmn:incoming><bpmn:outgoing>SequenceFlow_049okmm</bpmn:outgoing></bpmn:serviceTask><bpmn:serviceTask id="ServiceTask_19ckikx" name="определяем primaryId клиента" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/getAttribute/hlk_client_FL</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="method">GET</camunda:inputParameter><camunda:outputParameter name="hlk_client_app">${response}</camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1y6iyxf</bpmn:incoming><bpmn:outgoing>SequenceFlow_0ogml54</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_0ogml54" sourceRef="ServiceTask_19ckikx" targetRef="ServiceTask_0bqfhsr" /><bpmn:serviceTask id="ServiceTask_1sfgs21" name="Создаем заявку на закрытие счета" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/sendInstanceTo/BOOK/${instanceId}</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="payload"><camunda:script scriptFormat="javascript">S("{}")
.prop("ObjectType" , "accountClose")
.prop("hlk_Acc_Num" , accountNumber)
.prop("hlk_instance_app", instanceId)
.prop("hlk_account_number_contract" , agreementNumber)
.prop("hlk_client_app", S("{}")
.prop("primaryId" , hlk_client_app)
.prop("source" , source))
.prop("hlk_autostart" , true)
.toString()</camunda:script></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1gbmxzd</bpmn:incoming><bpmn:outgoing>SequenceFlow_0m5e6hw</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_0m5e6hw" sourceRef="ServiceTask_1sfgs21" targetRef="IntermediateCatchEvent_0zjaz3q" /><bpmn:serviceTask id="ServiceTask_0bqfhsr" name="Определяем source клиента" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/common/executeRequest</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload">{
	"find": "book",
	"filter": {
		"_id" : ObjectId("${instanceId}")
	},
	"projection": {
		"attributes.hlk_client_FL.source": 1,
                "attributes.hlk_client_FL.value": 1   
	}
}</camunda:inputParameter><camunda:outputParameter name="source"><camunda:script scriptFormat="javascript">JSON.parse(response).cursor.firstBatch[0].attributes.hlk_client_FL.source</camunda:script></camunda:outputParameter><camunda:outputParameter name="client"><camunda:script scriptFormat="javascript">JSON.parse(response).cursor.firstBatch[0].attributes.hlk_client_FL.primaryId</camunda:script></camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_0ogml54</bpmn:incoming><bpmn:outgoing>Flow_1vfyiqi</bpmn:outgoing></bpmn:serviceTask><bpmn:serviceTask id="ServiceTask_1logp5j" name="Определяем тип договора клиента"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/common/executeRequest</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload">{
	"find": "book",
	"filter": {
		"attributes.hlk_client_FL.primaryId": "${hlk_client_app}"
	},
	"projection": {
		"attributes.hlk_account_type_contract": 1,
                "attributes.hlk_account_number_contract": 1,
                "hlk_Contract_Start_Date":1
	}
}</camunda:inputParameter><camunda:outputParameter name="contractFound"><camunda:script scriptFormat="javascript">!!JSON.parse(response).cursor.firstBatch.length</camunda:script></camunda:outputParameter><camunda:outputParameter name="contractType"><camunda:script scriptFormat="javascript">try {
JSON.parse(response).cursor.firstBatch[0].attributes.hlk_account_type_contract
}
catch (e)
{
"0"
}</camunda:script></camunda:outputParameter><camunda:outputParameter name="found"><camunda:script scriptFormat="javascript">!!JSON.parse(response).cursor.firstBatch.length</camunda:script></camunda:outputParameter><camunda:outputParameter name="agreementNumber"><camunda:script scriptFormat="javascript">try {
JSON.parse(response).cursor.firstBatch[0].attributes.hlk_account_number_contract
}
catch (e)
{
"0"
}</camunda:script></camunda:outputParameter><camunda:outputParameter name="registrationDate"><camunda:script scriptFormat="JavaScript">try {
JSON.parse(response).cursor.firstBatch[0].attributes.hlk_Contract_Start_Date
}
catch (e)
{
"0"
}</camunda:script></camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_147irg6</bpmn:incoming><bpmn:outgoing>SequenceFlow_0s1fawc</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_0s1fawc" sourceRef="ServiceTask_1logp5j" targetRef="ServiceTask_0kgpjw4" /><bpmn:serviceTask id="ServiceTask_0kgpjw4" name="Записываем"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/setAttributes</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload">{
"hlk_account_type_contract" : "${contractType}"
}</camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_0s1fawc</bpmn:incoming><bpmn:outgoing>Flow_1ay6sja</bpmn:outgoing></bpmn:serviceTask><bpmn:serviceTask id="ServiceTask_0pn5gkg" name="Определяем есть ли у клиента активный счет в цд" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/common/executeRequest</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload">{
    "find": "invoice",
    "filter": {
        "attributes.hlk_account_owner.primaryId": "${hlk_client_app}",
        "activityStatus": "ACTIVE",
        "actual": true,
        "attributes.hlk_account_type": "Ценнобумажный",
        "attributes.hlk_clearing_system.primaryId": "5e46ac7457645400077899c7"
    },
    "projection": {
        "attributes.hlk_Account_Number": 1
    }
}</camunda:inputParameter><camunda:outputParameter name="accountNumber"><camunda:script scriptFormat="javascript">try {
JSON.parse(response).cursor.firstBatch[0].attributes.hlk_Account_Number
}
catch (e)
{
"0"
}</camunda:script></camunda:outputParameter><camunda:outputParameter name="found"><camunda:script scriptFormat="javascript">S(response).prop("cursor").prop("firstBatch").elements().isEmpty()</camunda:script></camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1b0hsxt</bpmn:incoming><bpmn:outgoing>SequenceFlow_0mp9b3b</bpmn:outgoing></bpmn:serviceTask><bpmn:intermediateCatchEvent id="IntermediateCatchEvent_0zjaz3q" camunda:asyncAfter="true"><bpmn:incoming>SequenceFlow_0m5e6hw</bpmn:incoming><bpmn:outgoing>SequenceFlow_0gwxlhz</bpmn:outgoing><bpmn:signalEventDefinition id="SignalEventDefinition_1rd3x4m" signalRef="Signal_1y42701" /></bpmn:intermediateCatchEvent><bpmn:sequenceFlow id="SequenceFlow_0gwxlhz" sourceRef="IntermediateCatchEvent_0zjaz3q" targetRef="ScriptTask_0t9joxl" /><bpmn:serviceTask id="ServiceTask_12mrb27" name="Статус заявки: Обработка: Заявка зарегистрирована"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/saveLabel/${instanceId}?label=Обработка:+Заявка+зарегистрирована</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1lbn7iv</bpmn:incoming><bpmn:outgoing>SequenceFlow_0jjusqr</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_0jjusqr" sourceRef="ServiceTask_12mrb27" targetRef="UserTask_09k3oyq" /><bpmn:userTask id="UserTask_09k3oyq" name="Подтверждение заявки" camunda:candidateGroups="cb_backoffice, cb_frontoffice, cb_middleoffice, jira-users"><bpmn:extensionElements><camunda:properties><camunda:property name="isEzdocTask" value="true" /><camunda:property name="ezdocTaskType" value="buttons" /></camunda:properties><camunda:taskListener event="create"><camunda:script scriptFormat="javascript">try {
              var formData = task.execution.processEngineServices.formService.getTaskFormData(task.id);
              var data = {};
              data.taskId = task.id;
              data.templateId = templateId;
              data.formKey = formData.formKey;
              var formFields = [];
              formData.formFields.forEach(function (a) {formFields.push(a.id)});
              data.formFields = formFields;

              httpPost(ezdocUrl + "/api/camunda/common/taskNotify?type=" + type + "&amp;instanceId=" + instanceId, JSON.stringify(data));
              }
              catch(error) {}

              /*************
              UTILITY FUNCTIONS
              *************/
              function httpPost(e,t,n){n=n||"application/json;charset=UTF-8";var a=new java.net.URL(e).openConnection();return a.requestMethod="POST",a.setRequestProperty("Content-Type",n),a.setRequestProperty("Accept-Charset", "UTF-8"),a.doOutput=!0,write(a.outputStream,t),asResponse(a)}function asResponse(e){return{data:read(e.inputStream),statusCode:e.responseCode}}function write(e,t){var n=new java.io.DataOutputStream(e);n.writeChars(t),n.flush(),n.close()}function read(e){for(var t,n=new java.io.BufferedReader(new java.io.InputStreamReader(e)),a=new java.lang.StringBuffer;null!=(t=n.readLine());)a.append(t);return n.close(),a.toString()}</camunda:script></camunda:taskListener><camunda:formData><camunda:formField id="{&#34;id&#34;:&#34;Accept&#34;,&#34;label&#34;:&#34;Подтвердить&#34;,&#34;type&#34;:&#34;simple&#34;}" type="string" /><camunda:formField id="{&#34;id&#34;: &#34;Cancel&#34;, &#34;label&#34;: &#34;Отклонить&#34;, &#34;type&#34;:&#34;fillingParam&#34;,&#34;params&#34;: [  {&#34;name&#34;: &#34;hlk_reason_close&#34;, &#34;label&#34;: &#34;Причина отклонения&#34;, &#34;type&#34;: &#34;string&#34;} ]}" type="string" /><camunda:formField id="hlk_Contract_Expiration_Date" label="Дата окончания договора" type="string" /><camunda:formField id="hlk_account_number_contract" label="Наименование договора" type="string" /><camunda:formField id="hlk_client_FL" label="Клиент (Договор)" type="string" /><camunda:formField id="hlk_account_type_contract" label="Вид договора" type="string" /></camunda:formData></bpmn:extensionElements><bpmn:incoming>SequenceFlow_0jjusqr</bpmn:incoming><bpmn:outgoing>SequenceFlow_0ql1yqg</bpmn:outgoing><bpmn:outgoing>SequenceFlow_0e0oqob</bpmn:outgoing></bpmn:userTask><bpmn:sequenceFlow id="SequenceFlow_0ql1yqg" sourceRef="UserTask_09k3oyq" targetRef="ServiceTask_0ryhu39"><bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${buttonId == 'Accept'}</bpmn:conditionExpression></bpmn:sequenceFlow><bpmn:serviceTask id="ServiceTask_1bs448z" name="Статус заявки: Обработка: Заявка зарегистрирована"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/saveLabel/${instanceId}?label=Заявка+отклонена</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_0e0oqob</bpmn:incoming><bpmn:incoming>SequenceFlow_1u2vdzy</bpmn:incoming><bpmn:outgoing>SequenceFlow_1op4vj9</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_0e0oqob" sourceRef="UserTask_09k3oyq" targetRef="ServiceTask_1bs448z"><bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${buttonId == 'Cancel'}</bpmn:conditionExpression></bpmn:sequenceFlow><bpmn:serviceTask id="ServiceTask_0yd8iop" name="Сообщаем об окончании процесса"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/processCompleted/${instanceId}</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1op4vj9</bpmn:incoming><bpmn:outgoing>SequenceFlow_0te0zkz</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_1op4vj9" sourceRef="ServiceTask_1bs448z" targetRef="ServiceTask_0yd8iop" /><bpmn:endEvent id="EndEvent_1tgvbul"><bpmn:incoming>SequenceFlow_0te0zkz</bpmn:incoming></bpmn:endEvent><bpmn:sequenceFlow id="SequenceFlow_0te0zkz" sourceRef="ServiceTask_0yd8iop" targetRef="EndEvent_1tgvbul" /><bpmn:serviceTask id="ServiceTask_0ryhu39" name="Статус заявки: Обработка: Заявка зарегистрирована"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/saveLabel/${instanceId}?label=Обработка:+Заявка+подтверждена</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_0ql1yqg</bpmn:incoming><bpmn:outgoing>SequenceFlow_1y6iyxf</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_1y6iyxf" sourceRef="ServiceTask_0ryhu39" targetRef="ServiceTask_19ckikx" /><bpmn:serviceTask id="ServiceTask_1mz6lhb" name="Статус заявки: Обработка: Заявка зарегистрирована"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/saveLabel/${instanceId}?label=Заявка+исполнена</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_0hvltsg</bpmn:incoming><bpmn:outgoing>SequenceFlow_18op69j</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_18op69j" sourceRef="ServiceTask_1mz6lhb" targetRef="Activity_1qdhdpf" /><bpmn:parallelGateway id="ExclusiveGateway_05e4ccw"><bpmn:incoming>Flow_01a10n4</bpmn:incoming><bpmn:outgoing>SequenceFlow_147irg6</bpmn:outgoing><bpmn:outgoing>SequenceFlow_1dhrlaj</bpmn:outgoing></bpmn:parallelGateway><bpmn:sequenceFlow id="SequenceFlow_147irg6" sourceRef="ExclusiveGateway_05e4ccw" targetRef="ServiceTask_1logp5j" /><bpmn:intermediateCatchEvent id="IntermediateCatchEvent_0kzifm2" camunda:asyncAfter="true"><bpmn:incoming>SequenceFlow_1dhrlaj</bpmn:incoming><bpmn:outgoing>SequenceFlow_1u2vdzy</bpmn:outgoing><bpmn:signalEventDefinition id="SignalEventDefinition_0zzqoz3" signalRef="Signal_093ky9o" /></bpmn:intermediateCatchEvent><bpmn:sequenceFlow id="SequenceFlow_1dhrlaj" sourceRef="ExclusiveGateway_05e4ccw" targetRef="IntermediateCatchEvent_0kzifm2" /><bpmn:sequenceFlow id="SequenceFlow_1u2vdzy" sourceRef="IntermediateCatchEvent_0kzifm2" targetRef="ServiceTask_1bs448z" /><bpmn:exclusiveGateway id="ExclusiveGateway_0e3hfu5" default="SequenceFlow_0lwp4n0"><bpmn:incoming>SequenceFlow_0mp9b3b</bpmn:incoming><bpmn:outgoing>SequenceFlow_1gbmxzd</bpmn:outgoing><bpmn:outgoing>SequenceFlow_0lwp4n0</bpmn:outgoing></bpmn:exclusiveGateway><bpmn:sequenceFlow id="SequenceFlow_0mp9b3b" sourceRef="ServiceTask_0pn5gkg" targetRef="ExclusiveGateway_0e3hfu5" /><bpmn:sequenceFlow id="SequenceFlow_1gbmxzd" sourceRef="ExclusiveGateway_0e3hfu5" targetRef="ServiceTask_1sfgs21"><bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${found == false}</bpmn:conditionExpression></bpmn:sequenceFlow><bpmn:sequenceFlow id="SequenceFlow_0lwp4n0" sourceRef="ExclusiveGateway_0e3hfu5" targetRef="ScriptTask_07xypp7" /><bpmn:serviceTask id="ServiceTask_0uv0l6e" name="Закрываем договор"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${referenceIdContract}/setAttributes</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload"><camunda:script scriptFormat="javascript">S("{}")
.prop("hlk_Contract_Expiration_Date", acceptDate)
.toString()</camunda:script></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_0wapku5</bpmn:incoming><bpmn:incoming>Flow_0fqi07n</bpmn:incoming><bpmn:outgoing>SequenceFlow_1caovqf</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_1caovqf" sourceRef="ServiceTask_0uv0l6e" targetRef="ServiceTask_0xm8211" /><bpmn:serviceTask id="ServiceTask_17neecy" name="Получаем инстанс айди выбранного договора" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/getRefId/hlk_account_number_contract</camunda:inputParameter><camunda:inputParameter name="method">GET</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter><camunda:outputParameter name="referenceIdContract">${response}</camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_1yygsmw</bpmn:incoming><bpmn:outgoing>SequenceFlow_1b0hsxt</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_1b0hsxt" sourceRef="ServiceTask_17neecy" targetRef="ServiceTask_0pn5gkg" /><bpmn:scriptTask id="ScriptTask_07xypp7" name="Получаем текущую дату" scriptFormat="JavaScript" camunda:resultVariable="acceptDate"><bpmn:incoming>SequenceFlow_0lwp4n0</bpmn:incoming><bpmn:outgoing>SequenceFlow_1mj7max</bpmn:outgoing><bpmn:script>JSON.stringify(new Date()).replace(/"/g, '').substring(0, 10)</bpmn:script></bpmn:scriptTask><bpmn:sequenceFlow id="SequenceFlow_1mj7max" sourceRef="ScriptTask_07xypp7" targetRef="Activity_1v3yux0" /><bpmn:scriptTask id="ScriptTask_0t9joxl" name="Получаем текущую дату" scriptFormat="JavaScript" camunda:resultVariable="acceptDate"><bpmn:incoming>SequenceFlow_0gwxlhz</bpmn:incoming><bpmn:outgoing>SequenceFlow_08prata</bpmn:outgoing><bpmn:script>JSON.stringify(new Date()).replace(/"/g, '').substring(0, 10)</bpmn:script></bpmn:scriptTask><bpmn:sequenceFlow id="SequenceFlow_08prata" sourceRef="ScriptTask_0t9joxl" targetRef="Activity_0tq61tb" /><bpmn:serviceTask id="ServiceTask_1b0lv09" name="определяем договор"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/getAttribute/hlk_account_number_contract</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="method">GET</camunda:inputParameter><camunda:outputParameter name="contractPrimary">${response}</camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_1ay6sja</bpmn:incoming><bpmn:outgoing>SequenceFlow_074hp1p</bpmn:outgoing></bpmn:serviceTask><bpmn:exclusiveGateway id="ExclusiveGateway_0zxg3gl" default="SequenceFlow_0fknits"><bpmn:incoming>SequenceFlow_0cly1mg</bpmn:incoming><bpmn:outgoing>SequenceFlow_0fknits</bpmn:outgoing><bpmn:outgoing>SequenceFlow_1lbn7iv</bpmn:outgoing></bpmn:exclusiveGateway><bpmn:serviceTask id="ServiceTask_0fc3pp9" name="Статус заявки: дублирующая заявка"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/saveLabel/${instanceId}?label=Заявка+отклонена.+Дубль.</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_0fknits</bpmn:incoming><bpmn:outgoing>SequenceFlow_1carbmg</bpmn:outgoing></bpmn:serviceTask><bpmn:serviceTask id="ServiceTask_0onq9yc" name="Сообщаем об окончании процесса"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/processCompleted/${instanceId}</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1carbmg</bpmn:incoming><bpmn:outgoing>SequenceFlow_19fqggn</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_074hp1p" sourceRef="ServiceTask_1b0lv09" targetRef="ServiceTask_0tp6ld0" /><bpmn:sequenceFlow id="SequenceFlow_0fknits" sourceRef="ExclusiveGateway_0zxg3gl" targetRef="ServiceTask_0fc3pp9" /><bpmn:sequenceFlow id="SequenceFlow_1carbmg" sourceRef="ServiceTask_0fc3pp9" targetRef="ServiceTask_0onq9yc" /><bpmn:sequenceFlow id="SequenceFlow_19fqggn" sourceRef="ServiceTask_0onq9yc" targetRef="EndEvent_1y7jpsj" /><bpmn:sequenceFlow id="SequenceFlow_1lbn7iv" sourceRef="ExclusiveGateway_0zxg3gl" targetRef="ServiceTask_12mrb27"><bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${found == true}</bpmn:conditionExpression></bpmn:sequenceFlow><bpmn:serviceTask id="ServiceTask_0tp6ld0" name="Ищем дубли"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/common/executeRequest</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload">{
	"find": "book",
	"filter": {
		"_id" : {$ne : ObjectId("${instanceId}")},
                "attributes.hlk_client_FL.primaryId" : "${hlk_client_app}",
                "attributes.hlk_account_number_contract.primaryId" : "${contractPrimary}",
 $and:[{"labelStatus" : {$ne : "Заявка отклонена"}},{"labelStatus" : {$ne : "Заявка отклонена. Дубль."}},{"labelStatus" : {$ne : "Заявка исполнена"}}]	
},
	"projection": {
		"attributes.hlk_client_FL.source": 1,
                "attributes.hlk_client_FL.value": 1   
	}
}</camunda:inputParameter><camunda:outputParameter name="found"><camunda:script scriptFormat="javascript">S(response).prop("cursor").prop("firstBatch").elements().isEmpty()</camunda:script></camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_074hp1p</bpmn:incoming><bpmn:outgoing>SequenceFlow_0cly1mg</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="SequenceFlow_0cly1mg" sourceRef="ServiceTask_0tp6ld0" targetRef="ExclusiveGateway_0zxg3gl" /><bpmn:serviceTask id="ServiceTask_0xm8211" name="Архивация" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:properties><camunda:property name="isEzdocServiceTask" value="true" /><camunda:property name="ezdocServiceTaskType" value="request" /><camunda:property name="requestType" value="GENERIC" /></camunda:properties><camunda:connector><camunda:inputOutput><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${referenceIdContract}/archive</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1caovqf</bpmn:incoming><bpmn:outgoing>Flow_0dhtgew</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_1ay6sja" sourceRef="ServiceTask_0kgpjw4" targetRef="ServiceTask_1b0lv09" /><bpmn:sequenceFlow id="Flow_1vfyiqi" sourceRef="ServiceTask_0bqfhsr" targetRef="Activity_1gyi6rj" /><bpmn:endEvent id="EndEvent_1y7jpsj"><bpmn:incoming>SequenceFlow_19fqggn</bpmn:incoming><bpmn:terminateEventDefinition id="TerminateEventDefinition_0izpnft" /></bpmn:endEvent><bpmn:endEvent id="EndEvent_0djl7a3"><bpmn:incoming>SequenceFlow_049okmm</bpmn:incoming><bpmn:terminateEventDefinition id="TerminateEventDefinition_0u31cfx" /></bpmn:endEvent><bpmn:serviceTask id="Activity_0qwq8zb" name="Деактивируем договор в терминале" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="method">DELETE</camunda:inputParameter><camunda:inputParameter name="url">${TAdress}/api/v1/data/agreements?externalId=${agreementPrimaryId}</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry><camunda:entry key="Authorization">Basic dHJhZGVyX2I6dHJhZGVyX2I=</camunda:entry></camunda:map></camunda:inputParameter><camunda:outputParameter name="success"><camunda:script scriptFormat="javascript">JSON.parse(response).success</camunda:script></camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_0jw4h8p</bpmn:incoming><bpmn:incoming>Flow_0dhtgew</bpmn:incoming><bpmn:outgoing>Flow_1vbpilv</bpmn:outgoing></bpmn:serviceTask><bpmn:exclusiveGateway id="Gateway_0c2yfmh"><bpmn:incoming>Flow_1vbpilv</bpmn:incoming><bpmn:outgoing>Flow_1o4kwsm</bpmn:outgoing><bpmn:outgoing>Flow_05e7f7t</bpmn:outgoing></bpmn:exclusiveGateway><bpmn:userTask id="Activity_13khez0" name="Повторить попытку" camunda:candidateGroups="cb_directordp, cb_headmiddleofice, cb_managermiddleoffice, jira-users, cb_clientmanager,"><bpmn:extensionElements><camunda:properties><camunda:property name="isEzdocTask" value="true" /><camunda:property name="ezdocTaskType" value="buttons" /></camunda:properties><camunda:taskListener event="create"><camunda:script scriptFormat="javascript">try {
              var formData = task.execution.processEngineServices.formService.getTaskFormData(task.id);
              var data = {};
              data.taskId = task.id;
              data.templateId = templateId;
              data.formKey = formData.formKey;
              var formFields = [];
              formData.formFields.forEach(function (a) {formFields.push(a.id)});
              data.formFields = formFields;

              httpPost(ezdocUrl + "/api/camunda/common/taskNotify?type=" + type + "&amp;instanceId=" + instanceId, JSON.stringify(data));
              }
              catch(error) {}

              /*************
              UTILITY FUNCTIONS
              *************/
              function httpPost(e,t,n){n=n||"application/json;charset=UTF-8";var a=new java.net.URL(e).openConnection();return a.requestMethod="POST",a.setRequestProperty("Content-Type",n),a.setRequestProperty("Accept-Charset", "UTF-8"),a.doOutput=!0,write(a.outputStream,t),asResponse(a)}function asResponse(e){return{data:read(e.inputStream),statusCode:e.responseCode}}function write(e,t){var n=new java.io.DataOutputStream(e);n.writeChars(t),n.flush(),n.close()}function read(e){for(var t,n=new java.io.BufferedReader(new java.io.InputStreamReader(e)),a=new java.lang.StringBuffer;null!=(t=n.readLine());)a.append(t);return n.close(),a.toString()}</camunda:script></camunda:taskListener><camunda:formData><camunda:formField id="{&#34;id&#34;:&#34;Retry&#34;,&#34;label&#34;:&#34;Повторить попытку отправки&#34;,&#34;type&#34;:&#34;simple&#34;}" type="string" /></camunda:formData></bpmn:extensionElements><bpmn:incoming>Flow_1o4kwsm</bpmn:incoming><bpmn:outgoing>Flow_0jw4h8p</bpmn:outgoing></bpmn:userTask><bpmn:sequenceFlow id="Flow_0jw4h8p" sourceRef="Activity_13khez0" targetRef="Activity_0qwq8zb" /><bpmn:sequenceFlow id="Flow_1vbpilv" sourceRef="Activity_0qwq8zb" targetRef="Gateway_0c2yfmh" /><bpmn:sequenceFlow id="Flow_1o4kwsm" sourceRef="Gateway_0c2yfmh" targetRef="Activity_13khez0"><bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${success == false}</bpmn:conditionExpression></bpmn:sequenceFlow><bpmn:sequenceFlow id="Flow_0dhtgew" sourceRef="ServiceTask_0xm8211" targetRef="Activity_0qwq8zb" /><bpmn:sequenceFlow id="Flow_05e7f7t" sourceRef="Gateway_0c2yfmh" targetRef="Activity_03ohgkn" /><bpmn:serviceTask id="Activity_1c7umtl" name="Получаем праймари айди выбранного договора" camunda:asyncAfter="true"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/getAttribute/hlk_account_number_contract</camunda:inputParameter><camunda:inputParameter name="method">GET</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter><camunda:outputParameter name="agreementPrimaryId">${response}</camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_1dy6hi4</bpmn:incoming><bpmn:outgoing>Flow_1yygsmw</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_1yygsmw" sourceRef="Activity_1c7umtl" targetRef="ServiceTask_17neecy" /><bpmn:userTask id="Activity_0yd0yk4" name="блок заполнения&#10;" camunda:formKey="FILL" camunda:assignee="${initiator}" camunda:candidateGroups="cb_backoffice, cb_frontoffice, cb_middleoffice, jira-users"><bpmn:extensionElements><camunda:properties><camunda:property name="isEzdocTask" value="true" /><camunda:property name="ezdocTaskType" value="fillverify" /></camunda:properties><camunda:formData><camunda:formField id="ezdocObjectUrl" type="string" /><camunda:formField id="ezdocObjectEditorUrl" type="string" /><camunda:formField id="hlk_Contract_Expiration_Date" label="Дата окончания договора" type="string" /><camunda:formField id="hlk_client_FL" label="Клиент (Договор)" type="string" /></camunda:formData><camunda:taskListener event="create"><camunda:script scriptFormat="javascript">try {
              var formData = task.execution.processEngineServices.formService.getTaskFormData(task.id);
              var data = {};
              data.taskId = task.id;
data.templateId = templateId;
data.formKey = formData.formKey;
              var formFields = [];
              formData.formFields.forEach(function (a) {formFields.push(a.id)});
              data.formFields = formFields;

              httpPost(ezdocUrl + "/api/camunda/common/taskNotify?type=" + type + "&amp;instanceId=" + instanceId, JSON.stringify(data));
              }
              catch(error) {}

              /*************
              UTILITY FUNCTIONS
              *************/
              function httpPost(e,t,n){n=n||"application/json;charset=UTF-8";var a=new java.net.URL(e).openConnection();return a.requestMethod="POST",a.setRequestProperty("Content-Type",n),a.setRequestProperty("Accept-Charset", "UTF-8"),a.doOutput=!0,write(a.outputStream,t),asResponse(a)}function asResponse(e){return{data:read(e.inputStream),statusCode:e.responseCode}}function write(e,t){var n=new java.io.DataOutputStream(e);n.writeChars(t),n.flush(),n.close()}function read(e){for(var t,n=new java.io.BufferedReader(new java.io.InputStreamReader(e)),a=new java.lang.StringBuffer;null!=(t=n.readLine());)a.append(t);return n.close(),a.toString()}</camunda:script></camunda:taskListener></bpmn:extensionElements><bpmn:incoming>Flow_1787doi</bpmn:incoming><bpmn:outgoing>Flow_1s490fs</bpmn:outgoing></bpmn:userTask><bpmn:serviceTask id="Activity_0iv9uei" name="Статус заявки: Обработка: Создание"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/saveLabel/${instanceId}?label=Обработка:+Создание</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_0dpnsng</bpmn:incoming><bpmn:outgoing>Flow_1787doi</bpmn:outgoing></bpmn:serviceTask><bpmn:serviceTask id="Activity_0kfp62i" name="определяем primaryId клиента"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/getAttribute/hlk_client_FL</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="method">GET</camunda:inputParameter><camunda:outputParameter name="hlk_client_app">${response}</camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_1s490fs</bpmn:incoming><bpmn:outgoing>Flow_01a10n4</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_1787doi" sourceRef="Activity_0iv9uei" targetRef="Activity_0yd0yk4" /><bpmn:sequenceFlow id="Flow_1s490fs" sourceRef="Activity_0yd0yk4" targetRef="Activity_0kfp62i" /><bpmn:sequenceFlow id="Flow_1hsa22q" sourceRef="StartEvent_1" targetRef="Activity_0rtlnz3" /><bpmn:sequenceFlow id="Flow_01a10n4" sourceRef="Activity_0kfp62i" targetRef="ExclusiveGateway_05e4ccw" /><bpmn:serviceTask id="Activity_1v3yux0" name="Меняем дату закрытия счета"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/setAttribute/hlk_Contract_Expiration_Date?incrementVersion=true&amp;value=${acceptDate}</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">**</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_1mj7max</bpmn:incoming><bpmn:outgoing>Flow_0wapku5</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_0wapku5" sourceRef="Activity_1v3yux0" targetRef="ServiceTask_0uv0l6e" /><bpmn:serviceTask id="Activity_0tq61tb" name="Меняем дату закрытия счета"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/setAttribute/hlk_Contract_Expiration_Date?incrementVersion=true&amp;value=${acceptDate}</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">**</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_08prata</bpmn:incoming><bpmn:outgoing>Flow_0fqi07n</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_0fqi07n" sourceRef="Activity_0tq61tb" targetRef="ServiceTask_0uv0l6e" /><bpmn:serviceTask id="Activity_1qdhdpf"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/camunda-error-description?errorDescription=</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>SequenceFlow_18op69j</bpmn:incoming><bpmn:outgoing>Flow_1jfor4c</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_1jfor4c" sourceRef="Activity_1qdhdpf" targetRef="Task_1ujk4ck" /><bpmn:scriptTask id="Activity_0rtlnz3" scriptFormat="javascript"><bpmn:incoming>Flow_1hsa22q</bpmn:incoming><bpmn:outgoing>Flow_0dpnsng</bpmn:outgoing><bpmn:script>execution.setVariable("TAdress", (java.lang.System).getenv("terminalUrl"))</bpmn:script></bpmn:scriptTask><bpmn:sequenceFlow id="Flow_0dpnsng" sourceRef="Activity_0rtlnz3" targetRef="Activity_0iv9uei" /><bpmn:serviceTask id="Activity_1gyi6rj" name="Получаем инстанс айди выбранного клиента"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/book/${instanceId}/getRefId/hlk_client_FL</camunda:inputParameter><camunda:inputParameter name="method">GET</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter><camunda:outputParameter name="referenceId">${response}</camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_1vfyiqi</bpmn:incoming><bpmn:outgoing>Flow_1dy6hi4</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_1dy6hi4" sourceRef="Activity_1gyi6rj" targetRef="Activity_1c7umtl" /><bpmn:serviceTask id="Activity_03ohgkn" name="Записываем"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="payload">{
"hlk_asset_account_open":"false",
"hlk_customer" : "false",
"Current_agreement" : "false"
}</camunda:inputParameter><camunda:inputParameter name="url">${ezdocUrl}/api/camunda/instance/individual/${referenceId}/setAttributes</camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Accept">*/*</camunda:entry></camunda:map></camunda:inputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_05e7f7t</bpmn:incoming><bpmn:outgoing>Flow_0hvltsg</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_0hvltsg" sourceRef="Activity_03ohgkn" targetRef="ServiceTask_1mz6lhb" /></bpmn:process><bpmn:signal id="Signal_1y42701" name="AccountClosed${hlk_client_app}" /><bpmn:signal id="Signal_093ky9o" name="AccountClosingReject${hlk_client_app}" /><bpmndi:BPMNDiagram id="BPMNDiagram_1"><bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="TEMPLATE_INSTANCE_PROCESS_hlk_contract_close_app_c2fc346c-2cf2-44f6-844f-af41fea44964"><bpmndi:BPMNEdge id="Flow_0hvltsg_di" bpmnElement="Flow_0hvltsg"><di:waypoint x="4070" y="381" /><di:waypoint x="4200" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1dy6hi4_di" bpmnElement="Flow_1dy6hi4"><di:waypoint x="2380" y="381" /><di:waypoint x="2420" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_0dpnsng_di" bpmnElement="Flow_0dpnsng"><di:waypoint x="360" y="381" /><di:waypoint x="420" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1jfor4c_di" bpmnElement="Flow_1jfor4c"><di:waypoint x="4440" y="381" /><di:waypoint x="4520" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_0fqi07n_di" bpmnElement="Flow_0fqi07n"><di:waypoint x="3410" y="341" /><di:waypoint x="3410" y="321" /><di:waypoint x="3520" y="321" /><di:waypoint x="3520" y="341" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_0wapku5_di" bpmnElement="Flow_0wapku5"><di:waypoint x="3320" y="250" /><di:waypoint x="3520" y="250" /><di:waypoint x="3520" y="341" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_01a10n4_di" bpmnElement="Flow_01a10n4"><di:waypoint x="790" y="381" /><di:waypoint x="805" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1hsa22q_di" bpmnElement="Flow_1hsa22q"><di:waypoint x="188" y="381" /><di:waypoint x="260" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1s490fs_di" bpmnElement="Flow_1s490fs"><di:waypoint x="650" y="381" /><di:waypoint x="690" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1787doi_di" bpmnElement="Flow_1787doi"><di:waypoint x="520" y="381" /><di:waypoint x="550" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1yygsmw_di" bpmnElement="Flow_1yygsmw"><di:waypoint x="2520" y="381" /><di:waypoint x="2540" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_05e7f7t_di" bpmnElement="Flow_05e7f7t"><di:waypoint x="3925" y="381" /><di:waypoint x="3970" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_0dhtgew_di" bpmnElement="Flow_0dhtgew"><di:waypoint x="3710" y="381" /><di:waypoint x="3740" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1o4kwsm_di" bpmnElement="Flow_1o4kwsm"><di:waypoint x="3900" y="356" /><di:waypoint x="3900" y="271" /><di:waypoint x="3840" y="271" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1vbpilv_di" bpmnElement="Flow_1vbpilv"><di:waypoint x="3840" y="381" /><di:waypoint x="3875" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_0jw4h8p_di" bpmnElement="Flow_0jw4h8p"><di:waypoint x="3790" y="311" /><di:waypoint x="3790" y="341" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1vfyiqi_di" bpmnElement="Flow_1vfyiqi"><di:waypoint x="2260" y="381" /><di:waypoint x="2280" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1ay6sja_di" bpmnElement="Flow_1ay6sja"><di:waypoint x="1130" y="381" /><di:waypoint x="1170" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0cly1mg_di" bpmnElement="SequenceFlow_0cly1mg"><di:waypoint x="1400" y="381" /><di:waypoint x="1455" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1lbn7iv_di" bpmnElement="SequenceFlow_1lbn7iv"><di:waypoint x="1505" y="381" /><di:waypoint x="1540" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_19fqggn_di" bpmnElement="SequenceFlow_19fqggn"><di:waypoint x="1180" y="240" /><di:waypoint x="1118" y="240" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1carbmg_di" bpmnElement="SequenceFlow_1carbmg"><di:waypoint x="1310" y="240" /><di:waypoint x="1280" y="240" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0fknits_di" bpmnElement="SequenceFlow_0fknits"><di:waypoint x="1480" y="356" /><di:waypoint x="1480" y="240" /><di:waypoint x="1410" y="240" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_074hp1p_di" bpmnElement="SequenceFlow_074hp1p"><di:waypoint x="1270" y="381" /><di:waypoint x="1300" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_08prata_di" bpmnElement="SequenceFlow_08prata"><di:waypoint x="3340" y="381" /><di:waypoint x="3360" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1mj7max_di" bpmnElement="SequenceFlow_1mj7max"><di:waypoint x="3150" y="250" /><di:waypoint x="3220" y="250" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1b0hsxt_di" bpmnElement="SequenceFlow_1b0hsxt"><di:waypoint x="2640" y="381" /><di:waypoint x="2660" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1caovqf_di" bpmnElement="SequenceFlow_1caovqf"><di:waypoint x="3570" y="381" /><di:waypoint x="3610" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0lwp4n0_di" bpmnElement="SequenceFlow_0lwp4n0"><di:waypoint x="2930" y="356" /><di:waypoint x="2930" y="250" /><di:waypoint x="3050" y="250" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1gbmxzd_di" bpmnElement="SequenceFlow_1gbmxzd"><di:waypoint x="2955" y="381" /><di:waypoint x="2980" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0mp9b3b_di" bpmnElement="SequenceFlow_0mp9b3b"><di:waypoint x="2760" y="381" /><di:waypoint x="2905" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1u2vdzy_di" bpmnElement="SequenceFlow_1u2vdzy"><di:waypoint x="830" y="222" /><di:waypoint x="830" y="180" /><di:waypoint x="1710" y="180" /><di:waypoint x="1710" y="200" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1dhrlaj_di" bpmnElement="SequenceFlow_1dhrlaj"><di:waypoint x="830" y="356" /><di:waypoint x="830" y="258" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_147irg6_di" bpmnElement="SequenceFlow_147irg6"><di:waypoint x="855" y="381" /><di:waypoint x="910" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_18op69j_di" bpmnElement="SequenceFlow_18op69j"><di:waypoint x="4300" y="381" /><di:waypoint x="4340" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1y6iyxf_di" bpmnElement="SequenceFlow_1y6iyxf"><di:waypoint x="1990" y="381" /><di:waypoint x="2040" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0te0zkz_di" bpmnElement="SequenceFlow_0te0zkz"><di:waypoint x="1800" y="120" /><di:waypoint x="1852" y="120" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1op4vj9_di" bpmnElement="SequenceFlow_1op4vj9"><di:waypoint x="1750" y="200" /><di:waypoint x="1750" y="160" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0e0oqob_di" bpmnElement="SequenceFlow_0e0oqob"><di:waypoint x="1750" y="341" /><di:waypoint x="1750" y="280" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0ql1yqg_di" bpmnElement="SequenceFlow_0ql1yqg"><di:waypoint x="1800" y="381" /><di:waypoint x="1890" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0jjusqr_di" bpmnElement="SequenceFlow_0jjusqr"><di:waypoint x="1640" y="381" /><di:waypoint x="1700" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0gwxlhz_di" bpmnElement="SequenceFlow_0gwxlhz"><di:waypoint x="3198" y="381" /><di:waypoint x="3240" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0s1fawc_di" bpmnElement="SequenceFlow_0s1fawc"><di:waypoint x="1010" y="381" /><di:waypoint x="1030" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0m5e6hw_di" bpmnElement="SequenceFlow_0m5e6hw"><di:waypoint x="3080" y="381" /><di:waypoint x="3162" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0ogml54_di" bpmnElement="SequenceFlow_0ogml54"><di:waypoint x="2140" y="381" /><di:waypoint x="2160" y="381" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_049okmm_di" bpmnElement="SequenceFlow_049okmm"><di:waypoint x="4620" y="381" /><di:waypoint x="4652" y="381" /><bpmndi:BPMNLabel><dc:Bounds x="1026.5" y="99" width="0" height="12" /></bpmndi:BPMNLabel></bpmndi:BPMNEdge><bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1"><dc:Bounds x="152" y="363" width="36" height="36" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_1ezl3om_di" bpmnElement="Task_1ujk4ck"><dc:Bounds x="4520" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_19ckikx_di" bpmnElement="ServiceTask_19ckikx"><dc:Bounds x="2040" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_1sfgs21_di" bpmnElement="ServiceTask_1sfgs21"><dc:Bounds x="2980" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0bqfhsr_di" bpmnElement="ServiceTask_0bqfhsr"><dc:Bounds x="2160" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_1logp5j_di" bpmnElement="ServiceTask_1logp5j"><dc:Bounds x="910" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0kgpjw4_di" bpmnElement="ServiceTask_0kgpjw4"><dc:Bounds x="1030" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0pn5gkg_di" bpmnElement="ServiceTask_0pn5gkg"><dc:Bounds x="2660" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="IntermediateCatchEvent_0zjaz3q_di" bpmnElement="IntermediateCatchEvent_0zjaz3q"><dc:Bounds x="3162" y="363" width="36" height="36" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_12mrb27_di" bpmnElement="ServiceTask_12mrb27"><dc:Bounds x="1540" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="UserTask_09k3oyq_di" bpmnElement="UserTask_09k3oyq" bioc:stroke="rgb(67, 160, 71)" bioc:fill="rgb(200, 230, 201)"><dc:Bounds x="1700" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_1bs448z_di" bpmnElement="ServiceTask_1bs448z"><dc:Bounds x="1700" y="200" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0yd8iop_di" bpmnElement="ServiceTask_0yd8iop"><dc:Bounds x="1700" y="80" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="EndEvent_1tgvbul_di" bpmnElement="EndEvent_1tgvbul"><dc:Bounds x="1852" y="102" width="36" height="36" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0ryhu39_di" bpmnElement="ServiceTask_0ryhu39"><dc:Bounds x="1890" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_1mz6lhb_di" bpmnElement="ServiceTask_1mz6lhb"><dc:Bounds x="4200" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ParallelGateway_0fisuv7_di" bpmnElement="ExclusiveGateway_05e4ccw"><dc:Bounds x="805" y="356" width="50" height="50" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="IntermediateCatchEvent_0kzifm2_di" bpmnElement="IntermediateCatchEvent_0kzifm2"><dc:Bounds x="812" y="222" width="36" height="36" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ExclusiveGateway_0e3hfu5_di" bpmnElement="ExclusiveGateway_0e3hfu5" isMarkerVisible="true"><dc:Bounds x="2905" y="356" width="50" height="50" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0uv0l6e_di" bpmnElement="ServiceTask_0uv0l6e"><dc:Bounds x="3470" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_17neecy_di" bpmnElement="ServiceTask_17neecy"><dc:Bounds x="2540" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ScriptTask_07xypp7_di" bpmnElement="ScriptTask_07xypp7"><dc:Bounds x="3050" y="210" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ScriptTask_0t9joxl_di" bpmnElement="ScriptTask_0t9joxl"><dc:Bounds x="3240" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_1b0lv09_di" bpmnElement="ServiceTask_1b0lv09"><dc:Bounds x="1170" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ExclusiveGateway_0zxg3gl_di" bpmnElement="ExclusiveGateway_0zxg3gl" isMarkerVisible="true"><dc:Bounds x="1455" y="356" width="50" height="50" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0fc3pp9_di" bpmnElement="ServiceTask_0fc3pp9"><dc:Bounds x="1310" y="200" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0onq9yc_di" bpmnElement="ServiceTask_0onq9yc"><dc:Bounds x="1180" y="200" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0tp6ld0_di" bpmnElement="ServiceTask_0tp6ld0"><dc:Bounds x="1300" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_0xm8211_di" bpmnElement="ServiceTask_0xm8211"><dc:Bounds x="3610" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Event_1thecao_di" bpmnElement="EndEvent_1y7jpsj"><dc:Bounds x="1082" y="222" width="36" height="36" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Event_0oxuvuc_di" bpmnElement="EndEvent_0djl7a3"><dc:Bounds x="4652" y="363" width="36" height="36" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_0qwq8zb_di" bpmnElement="Activity_0qwq8zb"><dc:Bounds x="3740" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Gateway_0c2yfmh_di" bpmnElement="Gateway_0c2yfmh" isMarkerVisible="true"><dc:Bounds x="3875" y="356" width="50" height="50" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_13khez0_di" bpmnElement="Activity_13khez0" bioc:stroke="rgb(67, 160, 71)" bioc:fill="rgb(200, 230, 201)"><dc:Bounds x="3740" y="231" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_1c7umtl_di" bpmnElement="Activity_1c7umtl"><dc:Bounds x="2420" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_0yd0yk4_di" bpmnElement="Activity_0yd0yk4" bioc:stroke="rgb(67, 160, 71)" bioc:fill="rgb(200, 230, 201)"><dc:Bounds x="550" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_0iv9uei_di" bpmnElement="Activity_0iv9uei"><dc:Bounds x="420" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_0kfp62i_di" bpmnElement="Activity_0kfp62i"><dc:Bounds x="690" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_1v3yux0_di" bpmnElement="Activity_1v3yux0"><dc:Bounds x="3220" y="210" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_0tq61tb_di" bpmnElement="Activity_0tq61tb"><dc:Bounds x="3360" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_1qdhdpf_di" bpmnElement="Activity_1qdhdpf"><dc:Bounds x="4340" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_0rtlnz3_di" bpmnElement="Activity_0rtlnz3"><dc:Bounds x="260" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_1gyi6rj_di" bpmnElement="Activity_1gyi6rj"><dc:Bounds x="2280" y="341" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_03ohgkn_di" bpmnElement="Activity_03ohgkn"><dc:Bounds x="3970" y="341" width="100" height="80" /></bpmndi:BPMNShape></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></bpmn:definitions>